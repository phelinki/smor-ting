name: Railway Deployment Health Check

on:
  workflow_dispatch:
  schedule:
    # Run every 30 minutes to check deployment health
    - cron: '*/30 * * * *'
  push:
    branches: [main]
    paths:
      - 'smor_ting_backend/**'
      - 'railway.toml'
      - '.github/workflows/railway-deployment-health.yml'

jobs:
  railway-health-check:
    runs-on: ubuntu-latest
    name: ğŸ©º Railway Deployment Health Check
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ¹ Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        
    - name: ğŸ“¦ Install Railway CLI
      run: |
        npm install -g @railway/cli
        
    - name: ğŸ” Authenticate Railway
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        if [ -z "$RAILWAY_TOKEN" ]; then
          echo "âš ï¸ RAILWAY_TOKEN not set - skipping Railway operations"
          exit 0
        fi
        echo "ğŸ” Railway authentication successful"
        
    - name: ğŸ—ï¸ Build Monitoring Tool
      run: |
        cd ${{ github.workspace }}
        go build -o railway_monitor ./scripts/railway_deployment_monitor.go
        chmod +x railway_monitor
        
    - name: ğŸ” Check Railway Configuration
      run: |
        echo "ğŸ“‹ Checking Railway configuration..."
        if [ -f "railway.toml" ]; then
          echo "âœ… Found railway.toml"
          echo "ğŸ“„ Watch patterns:"
          grep -A 10 "watchPatterns" railway.toml || echo "No watchPatterns found"
        else
          echo "âŒ No railway.toml found"
          exit 1
        fi
        
    - name: ğŸ©º Health Check
      run: |
        echo "ğŸ©º Performing health check..."
        ./railway_monitor health || {
          echo "âŒ Health check failed, attempting recovery..."
          ./railway_monitor redeploy
          sleep 120
          ./railway_monitor monitor
        }
        
    - name: âœ… Verify Deployment Status
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        if [ -n "$RAILWAY_TOKEN" ]; then
          echo "ğŸ“Š Railway deployment status:"
          railway status || echo "Could not get Railway status"
          
          echo "ğŸ“‹ Recent deployment logs:"
          railway logs | tail -20 || echo "Could not get Railway logs"
        fi
        
    - name: ğŸ§ª Run Deployment Tests
      run: |
        cd smor_ting_backend
        echo "ğŸ§ª Running deployment health tests..."
        go test ./tests/deployment_health_test.go -v
        go test ./tests/railway_fix_test.go -v
        
    - name: ğŸ“Š Report Results
      if: always()
      run: |
        echo "ğŸ“Š Deployment Health Check Complete"
        echo "ğŸ”— Railway URL: https://smor-ting-production.up.railway.app"
        echo "ğŸ”— Custom Domain: https://smor-ting.com"
        
        # Test both endpoints
        echo "ğŸ§ª Testing endpoints..."
        curl -f https://smor-ting-production.up.railway.app/health && echo "âœ… Railway URL healthy" || echo "âŒ Railway URL failed"
        curl -f https://smor-ting.com/health && echo "âœ… Custom domain healthy" || echo "âŒ Custom domain failed"
        
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: railway-health-check
    if: failure()
    steps:
    - name: ğŸš¨ Notify Deployment Failure
      run: |
        echo "ğŸš¨ Railway deployment health check failed!"
        echo "This indicates a persistent deployment issue that needs immediate attention."
        echo "Check the Railway dashboard and logs for details."
        echo "Consider running: railway redeploy --force"
